<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <title>Rocketship Game</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="mturk.js"></script>

  <script>

  var board = [
  [0, 0, 0, 1, 0, 0],
  [0, 0, 0, 0, 1, 1],
  [0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0],
  [1, 1, 1, 0, 0, 0],
  [0, 0, 0, 0, 0, 0],
  [0, 0, 0, 0, 0, 0]
  ];

  var gridcellsize = 50;
  var shipx = 0;
  var lastOffset = 0;
  var seconds = 0;
  var reward = 0;

  $(document).ready(function() {

    // Create the gameboard
    var gameboard = $("<div id='gameboard'></div>");
    $(document.body).append(gameboard);

    // Create the grid cells on the board. (piece = a grid cell)
    for (i = 0; i < board.length-1; i++) {
      for (j = 0; j < board[0].length; j++) {
        var pieceid = "gridcell_" + i + "_" + j;
        var piece = $("<div class='piece' id='NEWPIECE'></div>");
        $('#NEWPIECE').attr('id', pieceid);
        var piecey = i*gridcellsize;
        var piecex = j*gridcellsize;
        $(piece).css("top", piecey + "px");
        $(piece).css("left", piecex + "px");
        $(gameboard).append(piece);
      }
    }

    // Create the ship that the user controls
    var ship = $("<div class='ship'></div>");
    $(gameboard).append(ship);

    // Move the ship
    $(document).keydown(function(e) {
      if (e.keyCode == 37) {
        // left arrow clicked
        if (shipx == 0) {shipx = gridcellsize*(board[0].length-1);}
        else {shipx -= gridcellsize;}
      }
      else if (e.keyCode == 39) {
        // right arrow clicked
        if (shipx == gridcellsize*(board[0].length-1)) {shipx = 0;} 
        else {shipx += gridcellsize;}
      }
      $(".ship").css("left", shipx + "px");
    });

    // Automatically animate the board
    lastOffset = Math.floor(((new Date().getTime())/ 1000.0) % board.length);
    var animateInterval = setInterval(animate, 50);

    function animate() {
      var milliseconds = new Date().getTime();
      var offset = Math.floor((milliseconds / 1000.0) % board.length);
      
      // update board position based on current time
      for (i = 0; i < board.length-1; i++) {
        for (j = 0; j < board[0].length; j++) {

          var id = "gridcell_" + i + "_" + j;
          var index = i - offset;
          if (index < 0) {index = board.length + index;}

          // change grid cell colors to match offset position
          if (board[index][j] == 1) {
            $('#' + id).css("background-color", "blue");
             // check if ship crashed. if so, end and submit HIT.
             // THIS IS NOT WORKING EXACTLY AS IT SHOULD!?!?!?!?!?!
             if (i==board.length-2) {
              var gridcellx = j*gridcellsize;
              if (shipx == gridcellx) {
                alertAndEnd();
                // STOP GAME. WHY ISN'T CLEARINTERVAL WORKING?????
                clearInterval(animateInterval);
              }
            }
          }
          else {$('#' + id).css("background-color", "gray");}
        }
      }

      // display number of seconds player has survived and calculated reward
      var payCounter = $("<div id='payCounter' style='width:200px; height:150px; border-width:2px; border-style:solid; border-color:black; position:absolute; left:400px; top:50px; text-align:center; font-size: 200%;'></div>");
      $("#payCounter").html("<p>" + seconds + " seconds" + "</p><p>" + "$" +reward.toFixed(3) + "</p>");
      $(document.body).append(payCounter);

      // update number of seconds player has survived and calculated reward
      if (offset != lastOffset) {
        seconds += 1; 
        $("#seconds").text(seconds);
        $("#seconds").val(seconds);
        reward += 0.001;
        $("#reward").text(reward.toFixed(3));
        $("#reward").val(reward);
      }
      lastOffset = offset;

      // end game once player has earned $2.00
      if (reward >= 2.000) {alertAndEnd();}
    }

    // Whenever game ends, display a message (alert) to worker and then automatically submit their HIT.
    function alertAndEnd() {
      var finalReward = reward.toFixed(3);
      alert("GAME OVER! You have earned $" + finalReward + ".");
      $("#mturk_form").submit();
    }
  });

</script>

<style>
#gameboard {
  background-color: gray;
  width: 300px;
  height: 300px;
  position: relative;
}

.piece {
  background-color: gray;
  width: 50px;
  height: 50px;
  position: absolute;
  left: 0px;
  top: 0px;
}

.ship {
  background-color: red;
  width: 50px;
  height: 50px;
  position: absolute;
  left: 0px;
  top: 250px;
}
</style>

</head>

<body>

  <form id="mturk_form">
    <input id="seconds" type="hidden" name="seconds">
    <input id="reward" type="hidden" name="reward">
  </form>

</body>

</html>